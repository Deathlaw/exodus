<?xml version="1.0"?>

<project name="plugin" basedir="." default="all">
  <fileset dir="${basedir}" id="dpr">
    <include name="*.dpr"/>
  </fileset>
  <pathconvert refid="dpr" property="base">
    <mapper type="regexp" from="\\([^\\]*)\.dpr" to="\1"/>
  </pathconvert>

  <pathconvert refid="dpr" property="bare">
    <mapper type="regexp" from="\\Ex(.*)\.dpr" to="\1"/>
  </pathconvert>

  <condition property='HTMLLogger'>
    <equals arg1="${bare}" arg2="HTMLLogger"/>
  </condition>

  <condition property="make.dll">
    <and>
      <or>
	<available file="${basedir}/plugin-info.nsh"/>
	<isset property="HTMLLogger"/>
      </or>
      <isset property='bare'/>
      <not>
	<equals arg1='${bare}' arg2='' trim='true'/>
      </not>
    </and>
  </condition>

  <condition property="make.plugin">
    <and>
      <isset property='make.dll'/>
      <not>
	<isset property="HTMLLogger"/>
      </not>
    </and>
  </condition>

  <target name="dll" if='make.dll'>
    <echo message='Making dll: ${base}'/>
    <echo message='opts: ${opts.delphi}'/>
    <echo message='opts: ${exodus.includes}'/>
    <apply dir="." executable="${dcc}" verbose='true'>
      <arg line='${opts.delphi}'/>
      <arg line="${exodus.includes}"/>
      <arg value="-E.."/>
      <fileset refid="dpr"/>
    </apply>

    <zip basedir='${basedir}/..' destfile='${basedir}/../${base}.zip' includes='${base}.dll'/>
  </target>

  <target name="plugin" if='make.plugin'>
    <echo message="Making Plugin: ${bare}"/>
    <length file='${base}.dll' property='size'/>

    <echo file="../plugin-sections-new.nsi" append="true">
      Section /o "${base}" SEC_${bare}
	  AddSize ${size}
	  Push "${base}"
	  Call DownloadPlugin
	  RegDll "\$INSTDIR\\plugins\\${base}.dll"
      SectionEnd
    </echo>

    <echo file="../plugin-desc-new.nsi" append="true">
!insertmacro MUI_DESCRIPTION_TEXT $${SEC_${base}} $$(DESC_${base})
    </echo>

    <echo file="../plugin-i18n-new.nsh" append="true">
!include "${basedir}\plugin-info.nsh"
    </echo>
  </target>

  <target name="all" depends="dll, plugin"/>
</project>
